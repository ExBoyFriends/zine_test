/* loader.js */

export function initLoader(loader, onComplete) {
  let finished = false;

  const fadeLayer =
    document.getElementById("fadeLayer") ||
    document.getElementById("fadeout") ||
    null;

  const safeComplete = () => {
    if (finished) return;
    finished = true;
    onComplete?.();
  };

  const finish = () => {
    if (finished) return;

    // loaderを確実に消す
    if (loader) {
      loader.style.animation = "none";
      loader.style.opacity = "0";
      loader.style.display = "none";
    }

    // fadeLayerがあれば開く
    if (fadeLayer) {
      fadeLayer.classList.add("hide");
      fadeLayer.style.pointerEvents = "none";
    }

    // 次フレームで確実に進行
    requestAnimationFrame(safeComplete);
  };

  const start = () => {
    if (finished) return;

    if (loader) {
      loader.style.display = "block";
      loader.style.opacity = "1";
      loader.style.animation = "siren 2s linear infinite";
    }

    if (fadeLayer) {
      fadeLayer.classList.remove("hide");
      fadeLayer.style.pointerEvents = "auto";
    }

    // 演出時間後は必ず終了
    setTimeout(finish, 4200);
  };

  /* ===== 初回ロード ===== */
  if (document.readyState === "complete") {
    start();
  } else {
    window.addEventListener("load", start, { once: true });
  }

  /* ===== bfcache復帰 ===== */
  window.addEventListener("pageshow", e => {
    if (!e.persisted) return;

    if (loader) {
      loader.style.display = "none";
      loader.style.opacity = "0";
      loader.style.animation = "none";
    }

    if (fadeLayer) {
      fadeLayer.classList.add("hide");
      fadeLayer.style.pointerEvents = "none";
    }

    safeComplete();
  });
}
  
  /* =====================
   Fade Layer
===================== */
#fadeLayer {
  position: fixed;
  inset: 0;
  background: #000;
  z-index: 9998;
  opacity: 1;
  transition: opacity 1.2s ease;
  pointer-events: auto;
}

#fadeLayer.hide {
  opacity: 0;
  pointer-events: none;
}

